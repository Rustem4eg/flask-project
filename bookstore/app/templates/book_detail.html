{% extends "base.html" %}
{% block content %}
<div class="row">
  <div class="col-md-4">
    <img src="{{ url_for('static', filename=book.cover) }}" class="img-fluid rounded" alt="{{ book.title }}">
  </div>
  <div class="col-md-8">
    <h1>{{ book.title }}</h1>
    <p><strong>Автор:</strong> {{ book.author }}</p>
    <p><strong>Год:</strong> {{ book.year or '—' }}</p>
    <p><strong>Жанр:</strong> 
      {% for g in book.genres %}
        {{ g.name }}{% if not loop.last %}, {% endif %}
      {% endfor %}
    </p>
    <p><strong>Цена:</strong> {{ "%.2f"|format(book.price) }} ₽</p>
    <p><strong>Рейтинг:</strong> ★ {{ "%.1f"|format(book.rating) }} ({{ book.review_count }} отзывов)</p>
    <p>{{ book.description or 'Описание отсутствует.' }}</p>
    {% if current_user.is_authenticated %}
      <a href="{{ url_for('main.add_to_cart', book_id=book.id) }}" class="btn btn-success">Добавить в корзину</a>
    {% else %}
      <a href="{{ url_for('auth.login') }}" class="btn btn-success">Войдите, чтобы добавить в корзину</a>
    {% endif %}
  </div>
</div>

<hr>

{% if current_user.is_authenticated %}
<h3>Оставить отзыв</h3>
<form method="POST">
  {{ form.hidden_tag() }}
  <div class="mb-3">
    {{ form.rating.label(class="form-label") }}
    {{ form.rating(class="form-select") }}
  </div>
  <div class="mb-3">
    {{ form.comment.label(class="form-label") }}
    {{ form.comment(class="form-control", rows=3) }}
  </div>
  {{ form.submit(class="btn btn-primary") }}
</form>
{% else %}
<p><a href="{{ url_for('auth.login') }}">Войдите</a>, чтобы оставить отзыв.</p>
{% endif %}

<h3 class="mt-4">Отзывы ({{ book.reviews|length }})</h3>
{% for review in book.reviews %}
  <div class="card mb-2">
    <div class="card-body">
      <p class="mb-1"><strong>{{ review.user.name }}</strong> — ★ {{ review.rating }}</p>
      <small class="text-muted">{{ review.created_at.strftime('%d.%m.%Y') }}</small>
      <p class="mt-2">{{ review.comment or 'Без комментария' }}</p>
    </div>
  </div>
{% else %}
  <p>Отзывов пока нет.</p>
{% endfor %}
{% endblock %}